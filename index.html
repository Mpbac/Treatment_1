<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Buying Tips: Get a Good Deal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
      <style>
    :root {
      --dartmouth-green: #00693e;
      --forest-green: #228B22;
      --off-white: #f8f8f8;
    }

    body {
      background-color: var(--off-white);
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .form-card {
      max-width: 700px;
      margin: 20px auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 10px;
      overflow: hidden;
    }
    .hidden {
      display: none;
    }
    .message-box {
      margin: 20px auto;
      max-width: 600px;
      padding: 20px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
    }

    .message-box.is-danger {
       background-color: #f8d7da;
       color: #721c24;
       border-color: #f5c6cb;
    }

    .hero.is-primary.is-bold {
      background-color: var(--dartmouth-green);
      background-image: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .hero-body .container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero .title {
      color: white;
      font-size: 2.5em;
      font-weight: 600;
      margin-left: 1.5rem;
      margin-bottom: 0;
    }

    .banner-logo {
      max-height: 70px;
      width: auto;
    }

    .button.is-primary {
      background-color: var(--dartmouth-green);
      border-color: var(--dartmouth-green);
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .button.is-primary:hover,
    .button.is-primary:focus {
      background-color: #005a34;
      border-color: #005a34;
    }

    .button.is-success {
      background-color: var(--forest-green);
      border-color: var(--forest-green);
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .button.is-success:hover,
    .button.is-success:focus {
      background-color: #1e7d1e;
      border-color: #1e7d1e;
    }

    .label {
      font-weight: 600;
      color: #363636;
      margin-bottom: 0.75rem;
    }
    .field {
      margin-bottom: 1.5rem;
    }

    .input, .select select {
      border-color: #dbdbdb;
      box-shadow: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input:focus, .select select:focus, .textarea:focus {
      border-color: var(--forest-green);
      box-shadow: 0 0 0 0.125em rgba(34, 139, 34, 0.25);
    }

    .radio {
      margin-right: 1.5em;
      cursor: pointer;
    }

    .content p {
      line-height: 1.7;
      margin-bottom: 1em;
    }
    .content hr {
      background-color: #eee;
      height: 1px;
      margin: 2rem 0;
    }


    .modal-content {
      width: 95%;
      max-width: 1600px;
      height: 95%;
      max-height: 1200px;
      display: flex;
      flex-direction: column;
    }

    .modal-content .box {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      position: relative;
    }


    .iframe-container {
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      background-color: white;
    }

    .modal-content iframe {
      display: block;
      width: 100%;
      min-height: 100%;
      border: none;
    }

    .sticky-footer {
        position: sticky;
        bottom: 0;
        left: -20px;
        width: calc(100% + 40px);
        background-color: white;
        padding: 15px 20px;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 10;

        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .sticky-footer .confirm-text {
        margin-bottom: 10px !important;
        text-align: center;
        font-size: 0.9em;
    }

    .sticky-footer .control {
        width: 100%;
        text-align: center;
    }


    .modal .modal-close {
        top: 10px;
        right: 10px;
    }


    .help.is-danger {
        color: #f14668;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }


    @media (max-width: 768px) {
      .hero .title {
           font-size: 1.8em;
           margin-left: 1rem;
      }
       .hero-body .container {
           flex-direction: column;
           text-align: center;
      }
      .banner-logo {
           margin-bottom: 10px;
      }
      .hero .title {
           margin-left: 0;
      }
      .modal-content {
           width: 95%;
           height: 95%;
      }
       .modal-content .box {
         padding: 15px;
       }
       .sticky-footer {
           left: -15px;
           width: calc(100% + 30px);
           padding: 10px 15px;
       }
        .modal .modal-close {
            top: 5px;
            right: 5px;
       }
    }
  </style>
</head>
<body>
   <section class="hero is-primary is-bold">
    <div class="hero-body">
      <div class="container">
        <img src="D-Pine_Rev.png" alt="Dartmouth College Logo" class="banner-logo">
        <h1 class="title">Enrollment Form: Car Buying Study</h1>
      </div>
    </div>
  </section>

    <div class="container">
        <div class="cta-section has-text-centered">
            <p class="is-size-6">One more thing: here are some tips for how to get a good deal on your upcoming car purchase and loan. Feel free to bookmark this page or <a href="Treatment content.pdf" download="Car_Buying_Tips.pdf">download a PDF of these tips</a>.</p>
        </div>

        <h2 class="subtitle">1) Avoiding Add-Ons & Hidden Costs (Extra Charges & Fees)</h2>
        <p>These items warn against unnecessary or inflated dealer add-ons, forced accessories, hidden fees, and inflated markups.</p>
        <p class="section-header">a) Watch Out for Add-Ons That Can Drive Up the Price</p>
        <p>When you’re finalizing your car purchase, the dealer might offer you add-ons like extended warranties, paint protection, gap insurance, or window etching. These extras might sound useful, but they can quickly inflate the final price—sometimes by hundreds or even thousands of dollars. Before agreeing to any add-ons, ask yourself:</p>
        <ul>
            <li>Do I really need this?</li>
            <li>Can I buy it cheaper somewhere else?</li>
            <li>Is it already covered by the manufacturer or my insurance?</li>
        </ul>
        <p>Some add-ons are optional but presented like they’re required. Don’t feel pressured to accept anything you didn’t plan for. You have the right to decline extras you don’t want.</p>
        <p>Also, make sure all costs are listed clearly on the purchase agreement so nothing is hidden in the fine print. Focus on the “out-the-door price”—what you’re actually paying in total. By keeping an eye on add-ons, you can avoid paying for things you don’t need and save money.</p>

        <div class="feedback-section">
            <p class="is-size-6 has-text-centered mb-3">Please help our study by answering two more questions:</p>

            <form id="feedbackForm">
                <input type="hidden" id="timeSpentField" name="timeSpentOnPageMs" value="0">
                <input type="hidden" id="pageLoadTime" name="pageLoadTime" value="">
                <input type="hidden" id="pageUnloadTime" name="pageUnloadTime" value="">
                <input type="hidden" id="submissionTimestamp" name="submissionTimestamp" value="">
                <input type="hidden" id="demographicsSubmissionId" name="demographicsSubmissionId" value="">

                <div class="field">
                    <label class="label">Are these tips useful?</label>
                    <div class="control">
                        <label class="radio">
                            <input type="radio" name="tipsUseful" value="Yes" required> Yes
                        </label>
                        <label class="radio">
                            <input type="radio" name="tipsUseful" value="No"> No
                        </label>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Have you found any other useful tips? Please describe, or paste links:</label>
                    <div class="control">
                        <textarea class="textarea" name="otherTips" placeholder="e.g., 'I found that checking CarGurus helped me compare prices.' or paste links here."></textarea>
                    </div>
                </div>

                <div class="field has-text-centered">
                    <button class="button is-primary" type="submit" id="submitFeedbackBtn">Submit Feedback</button>
                </div>
            </form>
            <div id="feedback-thank-you" class="message-box is-success hidden mt-3">
                <p>Thank you for your feedback!</p>
            </div>
            <div id="feedback-error" class="message-box is-danger hidden mt-3">
                <p>There was an error submitting your feedback. Please try again.</p>
            </div>
        </div>

        <p class="footer-message">Thanks again for joining our study. We'll be in touch soon.</p>
    </div>

    <script>
        // !!! REPLACE with your actual Google Apps Script Web App URL for treatment page data submission !!!
        const treatmentScriptURL = "https://script.google.com/macros/s/AKfycbz74V9JXvlPx80mveoft0ODn9gm2z-YMqUijFoPZt3vy44CpOyOTwQJy8ADkuMDIVzcjg/exec"; // ** IMPORTANT: Change this **

        let pageLoadStartTime;

        function setTimestamp(field) {
            const now = new Date();
            const timestampString = now.getFullYear() + '-' +
                                   ('0' + (now.getMonth() + 1)).slice(-2) + '-' +
                                   ('0' + now.getDate()).slice(-2) + ' ' +
                                   ('0' + now.getHours()).slice(-2) + ':' +
                                   ('0' + now.getMinutes()).slice(-2) + ':' +
                                   ('0' + now.getSeconds()).slice(-2);
            field.value = timestampString;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Ensure all DOM elements are loaded before trying to access them
            const timeSpentField = document.getElementById('timeSpentField');
            const pageLoadTimeField = document.getElementById('pageLoadTime');
            const submissionTimestampField = document.getElementById('submissionTimestamp');
            const demographicsSubmissionIdField = document.getElementById('demographicsSubmissionId');
            const feedbackForm = document.getElementById('feedbackForm');
            const feedbackThankYou = document.getElementById('feedback-thank-you');
            const feedbackError = document.getElementById('feedback-error');
            const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');


            pageLoadStartTime = new Date().getTime();
            if (pageLoadTimeField) setTimestamp(pageLoadTimeField); // Record page load time

            // Get demographicsSubmissionId from URL if available
            const urlParams = new URLSearchParams(window.location.search);
            const demographicsId = urlParams.get('submissionId');
            if (demographicsId && demographicsSubmissionIdField) {
                demographicsSubmissionIdField.value = demographicsId;
            }

            // Only add event listener if the form exists
            if (feedbackForm) {
                feedbackForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    // Only update loading state if button exists
                    if (submitFeedbackBtn) {
                        submitFeedbackBtn.classList.add('is-loading');
                        submitFeedbackBtn.disabled = true;
                    }

                    // Hide messages from previous attempts
                    if (feedbackThankYou) feedbackThankYou.classList.add('hidden');
                    if (feedbackError) {
                        feedbackError.classList.add('hidden');
                        feedbackError.textContent = ''; // Clear any previous error text
                    }

                    const pageUnloadEndTime = new Date().getTime(); // Capture time at submission
                    const timeOnPageMs = pageUnloadEndTime - pageLoadStartTime;
                    if (timeSpentField) timeSpentField.value = timeOnPageMs;
                    if (submissionTimestampField) setTimestamp(submissionTimestampField); // Record submission time

                    const formData = new FormData(feedbackForm);
                    const params = new URLSearchParams();
                    for (const pair of formData.entries()) {
                        params.append(pair[0], pair[1]);
                    }
                    const formDataString = params.toString();

                    try {
                        const response = await fetch(treatmentScriptURL, {
                            method: "POST",
                            redirect: "follow", // browser follows redirects
                            body: formDataString,
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            //credentials: 'omit' // Added for clarity, default for same-origin
                        });

                        // Check if the HTTP status code indicates success (200-299 range)
                        if (!response.ok) {
                            let serverMessage = 'Unknown server error.';
                            try {
                                const errorData = await response.json(); // Try to parse as JSON
                                serverMessage = errorData.message || `Server status ${response.status}.`;
                            } catch (jsonParseError) {
                                // If it's not JSON, get the raw text for debugging
                                const rawResponse = await response.text();
                                serverMessage = `Server status ${response.status}. Response: ${rawResponse.substring(0, 100)}...`;
                            }
                            throw new Error(serverMessage); // Throw to be caught by the outer catch
                        }

                        // Parse the JSON response
                        const data = await response.json();
                        if (data && data.status === "success") {
                            if (feedbackThankYou) feedbackThankYou.classList.remove("hidden");
                            if (feedbackForm) feedbackForm.classList.add("hidden"); // Hide the form after successful submission
                        } else {
                            // Server responded with 200 OK, but 'status' in JSON is not 'success'
                            console.error('Submission failed as per server response:', data.message);
                            if (feedbackError) {
                                feedbackError.textContent = data.message || 'Submission failed. Server did not indicate success.';
                                feedbackError.classList.remove("hidden");
                            }
                        }
                    } catch (error) {
                        // This catch block handles network errors, CORS errors, and errors thrown above
                        console.error('Error submitting feedback:', error);
                        if (feedbackError) {
                            feedbackError.textContent = `Error: ${error.message || 'There was a network error or problem with the server. Please try again.'}`;
                            feedbackError.classList.remove("hidden");
                        }
                    } finally {
                        // Always remove loading state and re-enable button if form is still visible
                        if (submitFeedbackBtn) {
                            submitFeedbackBtn.classList.remove('is-loading');
                            if (feedbackForm && !feedbackForm.classList.contains('hidden')) {
                                submitFeedbackBtn.disabled = false;
                            }
                        }
                    }
                });
            } else {
                console.warn("Feedback form element not found. Form submission will not work.");
            }
        });

        // The 'beforeunload' event for 'pageUnloadTime' is generally unreliable for sending data
        // because the browser might kill the process before the fetch completes.
        // The current method of calculating timeOnPageMs at submission is more robust for study data.
        // If you absolutely need to capture unload time for *all* exits, consider navigator.sendBeacon.
        /*
        window.addEventListener('beforeunload', () => {
            const pageUnloadEndTime = new Date().getTime();
            const timeOnPageMs = pageUnloadEndTime - pageLoadStartTime;
            const pageUnloadTimeField = document.getElementById('pageUnloadTime');
            if (pageUnloadTimeField) {
                pageUnloadTimeField.value = new Date().toISOString(); // More robust time string
            }
            // For sending data on unload, `fetch` might be blocked. `navigator.sendBeacon` is better.
            // But since your design submits on button click, this part might not be strictly necessary for data.
        });
        */
    </script>
</body>
</html>
